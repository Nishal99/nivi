<!-- src/app/components/report-generation.component.html -->

<!-- Main wrapper with background and responsive padding -->
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-4 sm:p-8">
  <!-- Content container for max-width, centering, and vertical spacing between blocks -->
  <div class="max-w-7xl mx-auto space-y-8">
    
    <h2 class="text-3xl font-bold text-gray-800 text-center">Reports Generation</h2>
    
    <!-- Block 1: Form Section -->
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 w-full">
      <h3 class="text-xl font-semibold text-gray-800 mb-6 text-center">Generate Report</h3>
      <form [formGroup]="reportForm" (ngSubmit)="onSubmit()" class="space-y-6">
        <!-- Report Type Select -->
        <div>
          <label for="reportType" class="block text-sm font-semibold text-gray-700 mb-2">
            Select Report Type
          </label>
          <select 
            id="reportType" 
            formControlName="reportType"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 bg-white text-gray-800 appearance-none cursor-pointer"
            (change)="onReportTypeChange($event)"
          >
            <option value="client">Client Report</option>
            <option value="agent">Agent Report</option>
            <option value="visa">Visa Report</option>
          </select>
        </div>

        <!-- Agent Name Filter -->
        <div>
          <label for="agentName" class="block text-sm font-semibold text-gray-700 mb-2">
            Agent Name (Optional)
          </label>
          <div class="relative">
            <input 
              type="text" 
              id="agentName"
              formControlName="agentName"
              placeholder="Enter agent name"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 text-gray-800"
            >
            <!-- Agent Suggestions Dropdown -->
            <div *ngIf="agentSuggestions.length > 0" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
              <div *ngFor="let agent of agentSuggestions" 
                   (click)="selectAgent(agent)"
                   class="px-4 py-2 hover:bg-gray-100 cursor-pointer">
                {{ agent.name }}
              </div>
            </div>
            <!-- Loading Indicator -->
            <div *ngIf="isSearchingAgent" class="absolute right-3 top-3">
              <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"></div>
            </div>
          </div>
        </div>

        <!-- Date Range Inputs (shown for non-visa reports) -->
        <div *ngIf="reportForm.get('reportType')?.value !== 'visa'">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Select Date Range
          </label>
          <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
            <input 
              type="date" 
              id="startDate"
              formControlName="startDate"
              class="w-full md:flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 text-gray-800"
            >
            <input 
              type="date" 
              id="endDate"
              formControlName="endDate"
              class="w-full md:flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 text-gray-800"
            >
          </div>
        </div>

        <!-- Visa-Specific Filters (Conditional) -->
        <div *ngIf="reportForm.get('reportType')?.value === 'visa'" class="space-y-4 border-t pt-4">
          <h4 class="text-lg font-semibold text-gray-800">Visa Filters</h4>
          <!-- Visa expiry date range (Visa-specific) -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Visa Expiry Date Range</label>
            <div class="flex space-x-4">
              <input type="date" id="startDateVisa" formControlName="startDate" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <input type="date" id="endDateVisa" formControlName="endDate" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
          </div>
          
          <!-- Visa Source Type -->
          <div>
            <label for="sourceType" class="block text-sm font-semibold text-gray-700 mb-2">
              Visa Source Type
            </label>
            <select 
              id="sourceType" 
              formControlName="sourceType"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 bg-white text-gray-800 appearance-none cursor-pointer"
            >
              <option value="">All</option>
              <option value="DUBAI">DUBAI</option>
              <option value="SHARJAH">SHARJAH</option>
              <option value="ABU DHABI">ABU DHABI</option>
              <option value="RAS">RAS</option>
            </select>
          </div>

          <!-- Type of Visa -->
          <div>
            <label for="visaType" class="block text-sm font-semibold text-gray-700 mb-2">
              Type of Visa
            </label>
            <select 
              id="visaType" 
              formControlName="visaType"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 bg-white text-gray-800 appearance-none cursor-pointer"
            >
              <option value="">All</option>
              <option value="30 DAYS SINGLE ENTRY">30 DAYS SINGLE ENTRY</option>
              <option value="30 DAYS MULTIPLE ENTRY">30 DAYS MULTIPLE ENTRY</option>
              <option value="60 DAYS SINGLE ENTRY">60DAYS SINGLE ENTRY</option>
              <option value="60 DAYS MULTIPLE ENTRY">60 DAYS MULTIPLE ENTRY</option>
            </select>
          </div>

          <!-- Absconding Type -->
          <div>
            <label for="abscondingType" class="block text-sm font-semibold text-gray-700 mb-2">
              Absconding Type
            </label>
            <select 
              id="abscondingType" 
              formControlName="abscondingType"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 bg-white text-gray-800 appearance-none cursor-pointer"
            >
              <option value="">All</option>
              <option value="private">private</option>
              <option value="zero">zero</option>
            </select>
          </div>
        </div>

        <!-- Messages -->
        <div *ngIf="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
          {{ errorMessage }}
        </div>
        <div *ngIf="successMessage" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
          {{ successMessage }}
        </div>

        <!-- Generate Report Button -->
        <button 
          type="submit"
          [disabled]="isLoading || reportForm.invalid"
          class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span *ngIf="isLoading">Generating...</span>
          <span *ngIf="!isLoading">Generate Report</span>
        </button>
      </form>
    </div>

    <!-- Block 2: Results Section (Conditional) -->
    <div *ngIf="results && results.length > 0" class="bg-white rounded-xl shadow-lg p-6 md:p-8 w-full">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold text-gray-800">Filtered Report Results</h3>
        <button 
          (click)="downloadExcel()"
          [disabled]="isDownloading"
          class="flex items-center space-x-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
          <span>{{ isDownloading ? 'Downloading...' : 'Download Excel' }}</span>
        </button>
      </div>
      <div class="overflow-x-auto">

        <!-- Visa Report -->
        <table *ngIf="reportType === 'visa'" class="min-w-full bg-white border border-gray-200 rounded-lg">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agent</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visa Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry Date</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let item of results" class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.id }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <img [src]="getImageUrl(item.Image || item.image)" [alt]="item.first_name" (error)="onImageError($event)" class="h-10 w-10 rounded-full object-cover" />
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.agent_name }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.first_name }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.last_name }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.source_type }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.visa_type }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.created_date | date:'MM/dd/yy, h:mm a' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.expiry_date | date:'MM/dd/yy, h:mm a' }}</td>
            </tr>
          </tbody>
        </table>

        <!-- Client Report -->
        <table *ngIf="reportType === 'client'" class="min-w-full bg-white border border-gray-200 rounded-lg">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Passport</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visa Source</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visa Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Absconding</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agent</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let item of results" class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.Id ?? item.id }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <img [src]="getImageUrl(item.Image || item.image)" [alt]="item.First_Name || item.first_name" (error)="onImageError($event)" class="h-10 w-10 rounded-full object-cover" />
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.First_Name ?? item.first_name }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.Last_Name ?? item.last_name }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.uid ?? item.NIC_No ?? '' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.Passport_No ?? '' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.Email ?? '' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.visa_source ?? item.Visa_source ?? '' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.Visa_type ?? item.Visa_Type ?? '' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.absconding_type ?? item.Absconding_type ?? '' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.agent_name ?? item.companyName ?? '' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.expiry_date | date:'MM/dd/yy, h:mm a' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ (item.Created_At ?? item.created_date) | date:'MM/dd/yy, h:mm a' }}</td>
            </tr>
          </tbody>
        </table>

        <!-- Agent Report -->
        <div *ngIf="reportType === 'agent'" class="space-y-6">
          <div *ngFor="let agent of results" class="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <!-- Agent Information Header -->
            <div class="bg-gray-50 p-4 border-b border-gray-200">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <div class="text-xs font-medium text-gray-500 uppercase">Agent ID</div>
                  <div class="mt-1 text-sm text-gray-900">{{ agent.agent_id }}</div>
                </div>
                <div>
                  <div class="text-xs font-medium text-gray-500 uppercase">Company</div>
                  <div class="mt-1 text-sm text-gray-900">{{ agent.companyName }}</div>
                </div>
                <div>
                  <div class="text-xs font-medium text-gray-500 uppercase">Email</div>
                  <div class="mt-1 text-sm text-gray-900">{{ agent.email }}</div>
                </div>
                <div>
                  <div class="text-xs font-medium text-gray-500 uppercase">Contact</div>
                  <div class="mt-1 text-sm text-gray-900">{{ agent.contact }}</div>
                </div>
              </div>
              <div class="mt-2 text-xs text-gray-500">
                Created: {{ agent.agent_created_at | date:'MM/dd/yy, h:mm a' }}
              </div>
            </div>
            
            <!-- Clients Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Passport</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visa Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                    
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let client of agent.clients" class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                      <img [src]="getImageUrl(client.Image || client.image || client.client_image)" [alt]="client.first_name" (error)="onImageError($event)" class="h-10 w-10 rounded-full object-cover" />
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {{ client.first_name }} {{ client.last_name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ client.passport_no }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ client.email }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ client.visa_type }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ client.visa_source }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ client.expiry_date | date:'MM/dd/yy, h:mm a' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ client.created_at | date:'MM/dd/yy, h:mm a' }}</td>
                  </tr>
                  <tr *ngIf="agent.clients.length === 0">
                    <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                      No clients found for this agent
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Client Count -->
            <div class="bg-gray-50 px-4 py-2 border-t border-gray-200">
              <span class="text-sm text-gray-600">
                {{ agent.clients.length }} client{{ agent.clients.length === 1 ? '' : 's' }}
              </span>
            </div>
          </div>
        </div>

      </div>
      <div class="mt-4 text-center text-sm text-gray-600">
        Showing {{ results.length }} results
      </div>
    </div>

    <!-- Block 3: Empty State (Shows initially and when no results are found) -->
    <div *ngIf="!isLoading && (!results || results.length === 0)" class="bg-white rounded-xl shadow-lg p-6 md:p-8 w-full">
      <div class="text-center py-12">
        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">No Results Yet</h3>
        <p class="text-gray-600">Generate a report using the filters above to view data.</p>
      </div>
    </div>

  </div>
</div>